FROM alpine:latest

WORKDIR /src

# Install dependencies to get Django running
RUN apk update
RUN apk add python3 python3-dev \
        py-psycopg2 postgresql-dev \
        postgresql \
        linux-headers \
        build-base libffi-dev \
    rm -rf /var/cache/apk/*

# Install Django dependencies
RUN pip3 install --upgrade pip
COPY ./requirements.txt /requirements.txt
RUN pip3 install -r /requirements.txt

EXPOSE 8000

# Wait till the database is ready and then launch the dev server
CMD cd /src/lm && \
    sh /src/lm/sleep_until_dev_pg_isready.sh && \
    python3 manage.py migrate && \
    echo && \
    echo "Docker containers are up; server at: http://0.0.0.0:8000/" && \
    echo && \
    python3 manage.py runserver 0.0.0.0:8000
